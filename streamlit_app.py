import streamlit as st
import sys
import io
import docx

# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è©¦è¡Œ
try:
    import google.generativeai as genai
    import docx
except ImportError:
    st.error(
        "å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼š"
    )
    st.code("pip install google-generativeai python-docx")
    st.info(
        "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚"
    )
    st.stop()

# Streamlitã®UIè¨­å®š
st.title("ğŸ’¬ Chatbotã¨ä»Šæ—¥1æ—¥ã‚’æŒ¯ã‚Šè¿”ã‚ã†ï¼")
st.write(
    "TXTã‚‚ã—ãã¯DOCXå½¢å¼ã®å­¦ç¿’æ—¥è¨˜ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ãã®å†…å®¹ã«é–¢ã™ã‚‹å¯¾è©±ãŒã§ãã‚‹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ï¼"
)

# secretsã‹ã‚‰APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
try:
    gemini_api_key = st.secrets["google_api_key"]
    if not gemini_api_key:
        raise KeyError
except KeyError:
    st.error("APIã‚­ãƒ¼ãŒStreamlitã®secretsã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    st.info(
        "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`.streamlit/secrets.toml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€"
        "ä»¥ä¸‹ã®å½¢å¼ã§APIã‚­ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚\n\n"
        "```toml\n"
        "google_api_key = \"YOUR_API_KEY_HERE\"\n"
        "```"
        "\n`YOUR_API_KEY_HERE`ã‚’å®Ÿéš›ã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚"
    )
    st.stop()

# Gemini APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
genai.configure(api_key=gemini_api_key)
model = genai.GenerativeModel('gemini-2.5-flash-preview-05-20')

# === ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼ã®è¿½åŠ  ===
uploaded_file = st.file_uploader(
    "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„",
    type=['txt', 'docx']
)

# === ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹å¤‰æ•°ã®ä½œæˆ ===
if "messages" not in st.session_state:
    st.session_state.messages = []
if "document_content" not in st.session_state:
    st.session_state.document_content = None

# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã™ã‚‹
if uploaded_file is not None:
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€åº¦ã ã‘èª­ã¿è¾¼ã‚€
    if st.session_state.document_content is None:
        try:
            if uploaded_file.type == 'text/plain':
                # .txtãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€UTF-8ã§ãƒ‡ã‚³ãƒ¼ãƒ‰
                document_content = uploaded_file.getvalue().decode('utf-8')
            elif uploaded_file.type == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':
                # .docxãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€python-docxã§èª­ã¿è¾¼ã¿
                document = docx.Document(uploaded_file)
                paragraphs = [p.text for p in document.paragraphs]
                document_content = "\n".join(paragraphs)
            else:
                st.error("ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚")
                st.stop()
            
            st.session_state.document_content = document_content
            st.success("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚")
            st.session_state.messages = [] # æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
            st.info("ã“ã‚Œã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã«ã¤ã„ã¦è³ªå•ã§ãã¾ã™ã€‚")
            
            # === ã“ã“ã«æœ€åˆã®è³ªå•ã‚’ç”Ÿæˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  ===
            initial_prompt = f"ã“ã‚Œã‹ã‚‰ã‚ãªãŸã®å­¦ç¿’ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ä»Šæ—¥ã®å­¦ç¿’æ—¥è¨˜ã‚’æ‹è¦‹ã—ã¾ã—ãŸã€‚\n\nãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:\n{document_content}\n\nã¾ãšã¯ã€ã“ã®æ—¥ã®å­¦ç¿’ã§ä¸€ç•ªå°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã“ã¨ã«ã¤ã„ã¦æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ"
            
            with st.spinner("æ€è€ƒä¸­ã§ã™..."):
                response = model.generate_content(
                    initial_prompt,
                    stream=False # æœ€åˆã®ä¸€å›ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã¯ãªãã¦ã‚ˆã„
                )
            
            assistant_message = response.text
            st.session_state.messages.append({"role": "assistant", "content": assistant_message})

            st.rerun() # UIã‚’å†æç”»ã—ã¦ãƒãƒ£ãƒƒãƒˆã‚’è¡¨ç¤º

        except Exception as e:
            st.error(f"ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# === ãƒãƒ£ãƒƒãƒˆUIã®è¡¨ç¤º ===
if st.session_state.document_content is None:
    st.info("ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ã¾ãšãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
else:
    # æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ãƒãƒ£ãƒƒãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    if prompt := st.chat_input("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„"):
        
        # æœ€å¤§ãƒ©ãƒªãƒ¼æ•°ã‚’è¶…ãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if len(st.session_state.messages) >= 10: # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ãƒšã‚¢ã§5å›ãªã®ã§10
            st.info("ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã¯ã“ã‚Œã§çµ‚ã‚ã‚Šã«ã—ã¾ã—ã‚‡ã†ã€‚ã¾ãŸæ˜æ—¥ã‚‚é ‘å¼µã£ã¦ãã ã•ã„ã­ï¼")
            st.stop()
            
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¦è¡¨ç¤º
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        try:
            # Gemini APIã«æ¸¡ã™ãŸã‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã‚’å¤‰æ›
            history = []
            
            # === ã“ã“ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’ã‚·ã‚¹ãƒ†ãƒ æŒ‡ç¤ºã¨ã—ã¦æœ€åˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ  ===
            # å¯¾è©±çµ‚äº†ã¨ç·æ‹¬ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®æŒ‡ç¤ºã‚’è¿½åŠ 
            document_context = f"""
    # Please paste the text defining the chatbot's role here.
    # ã“ã“ã«ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®å½¹å‰²ã‚’å®šç¾©ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚

    ã‚ãªãŸã¯å„ªç§€ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒŠãƒ«ãƒ»ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã§ã‚ã‚Šã€å­¤ç‹¬ã®ä¸­ç‹¬å­¦ã‚’ã™ã‚‹æˆäººå­¦ç¿’è€…ã®è‡ªå·±æˆé•·ã‚’æ”¯æ´ã™ã‚‹ã‚³ãƒ¼ãƒã¨ã—ã¦ã®å½¹å‰²ã‚’æ‹…ã†è¦ªã—ã¿ã‚„ã™ã„ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’æ—¥è¨˜ã‚’èª­ã¿ã€å…±æ„Ÿã‚’ç¤ºã—ãªãŒã‚‰ã€ãã®æ—¥ã®å‡ºæ¥äº‹ã‚„æ„Ÿæƒ…ã«ã¤ã„ã¦ã•ã‚‰ã«æ·±ãæ˜ã‚Šä¸‹ã’ã‚‹ã‚ˆã†ãªè³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚çµè«–ã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ€¥ãã®ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒæ°—ã¥ãã‚’å¾—ã‚‰ã‚Œã‚‹ã‚ˆã†ã«å¯¾è©±ã‚’å°ã„ã¦ãã ã•ã„ã€‚ã“ã®å¯¾è©±ã¯æœ€å¤§5å›ã®ãƒ©ãƒªãƒ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã¨ã‚ãªãŸã®å¿œç­”ã®ãƒšã‚¢ï¼‰ã§çµ‚ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚å­¦ç¿’ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¾ã—ãŸã€‚ã“ã®å¾Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æ—¥è¨˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã®ã§ã€æ›¸ãè¾¼ã¿ã‚’è¸ã¾ãˆã¦å­¦ç¿’ç›®æ¨™ã‚’é”æˆã§ãã‚‹ã‚ˆã†Kellerã®ARCS-Vãƒ¢ãƒ‡ãƒ«ï¼ˆæ³¨æ„Attentionãƒ»é–¢é€£æ€§Relevanceãƒ»è‡ªä¿¡Confidenceãƒ»æº€è¶³Satisfactionãƒ»æ„å¿—Volitionï¼‰ã‚’è¸ã¾ãˆãŸå¯¾è©±ã‚’é€šã˜ã¦ã€å­¦ç¿’è€…ã®å­¦ç¿’æ„æ¬²ã®ç¶­æŒã¨å­¦ç¿’ç›®æ¨™é”æˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚
å‰æï¼šARCS-Vãƒ¢ãƒ‡ãƒ«ã®æœ¬æ–‡è„ˆã§ã®æ´»ç”¨ã«ã¤ã„ã¦
Kellerã®ARCS-Vãƒ¢ãƒ‡ãƒ«ã¯ã€å­¦ç¿’æ„æ¬²ã‚’é«˜ã‚ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ARCS-Vãƒ¢ãƒ‡ãƒ«ã¯ã€1983å¹´ã®ãƒ¢ãƒ‡ãƒ«æå”±ä»¥æ¥ã€æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ãŸæ çµ„ã¿ã«æ–°ãŸã«æ„å¿—ï¼ˆVolitionï¼‰ã‚’åŠ ãˆãŸæ‹¡å¼µã®çµæœæå”±ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸæ‹¡å¼µç‰ˆå‹•æ©Ÿã¥ã‘ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹ã€‚å­¦ç¿’æ•™æã‚„ç ”ä¿®ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆã™ã‚‹éš›ã«ç”¨ã„ã‚‹ã‚‚ã®ã§ã™ãŒã€è¦–ç‚¹ã‚’å¤‰ãˆã‚‹ã“ã¨ã§å­¦ç¿’è€…ã®æ„æ¬²ã‚’ç¶­æŒã‚‚ã—ãã¯é«˜ã‚ã‚‹ã‚ˆã†ãªã‚³ãƒ¼ãƒãƒ³ã‚°å¯¾è©±ã«ã‚‚ç”¨ã„ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨è€ƒãˆã‚‹ã€‚
â—‹æ³¨æ„Attentionï¼ã€Œé¢ç™½ãã†ã€ã€Œã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ã€ã¨ã„ã£ãŸå…·åˆã«ã€å­¦ç¿’è€…ã®èˆˆå‘³ã‚„çŸ¥çš„å¥½å¥‡å¿ƒã€ãã—ã¦æ¢æ±‚å¿ƒã‚’åˆºæ¿€ã™ã‚‹å´é¢ã§ã™ã€‚ã“ã®æ³¨æ„å–šèµ·ã¯ã€ã•ã‚‰ã«ä»¥ä¸‹ã®3ã¤ã«åˆ†é¡ã§ãã¾ã™ã€‚
ãƒ»çŸ¥è¦šçš„å–šèµ·ï¼šå­¦ç¿’è€…ã®èˆˆå‘³ã‚’å¼•ãå‡ºã™ãŸã‚ã«ä½•ãŒã§ãã‚‹ã‹ï¼Ÿ 
ãƒ»æ¢æ±‚å¿ƒã®å–šèµ·ï¼šã€Œå­¦ã³ãŸã„ã€ã¨ã„ã†æ°—æŒã¡ã‚’åˆºæ¿€ã™ã‚‹ãŸã‚ã«ä½•ãŒã§ãã‚‹ã‹ï¼Ÿ 
ãƒ»å¤‰åŒ–æ€§ï¼šã©ã†ã™ã‚Œã°å­¦ç¿’è€…ã®èˆˆå‘³ãƒ»é–¢å¿ƒã‚’ç¶­æŒã§ãã‚‹ã‹ï¼Ÿ
â—‹é–¢é€£æ€§Relevanceï¼å­¦ç¿’å†…å®¹ã«å¯¾ã™ã‚‹è¦ªã—ã¿ã‚„æ„ç¾©ã‚’æŒãŸã›ã€è‡ªã‚‰å­¦ã¶å§¿å‹¢ã‚’å½¢æˆã™ã‚‹å´é¢ã§ã™ã€‚å­¦ç¿’å†…å®¹ã®å°†æ¥çš„ãªä¾¡å€¤ã‚„å­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹ã®æ¥½ã—ã•ã‚’å®Ÿæ„Ÿã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€å­¦ç¿’è€…ã«ã€Œã‚„ã‚ŠãŒã„ã€ã‚’ã‚‚ãŸã›ã¾ã™ã€‚ã“ã®é–¢é€£æ€§ã¯ã€ã•ã‚‰ã«ä»¥ä¸‹ã®3ã¤ã«åˆ†é¡ã§ãã¾ã™ã€‚
ãƒ»è¦ªã—ã¿ã‚„ã™ã•ï¼šå­¦ç¿’å†…å®¹ã¨å­¦ç¿’è€…ã®çµŒé¨“ã‚’çµã³ã¤ã‘ã‚‹ãŸã‚ã«ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã‹ï¼Ÿ 
ãƒ»ç›®çš„æŒ‡å‘æ€§ï¼šå­¦ç¿’å†…å®¹ã¨å­¦ç¿’è€…ã®ç›®çš„ã‚’çµã³ã¤ã‘ã‚‹ãŸã‚ã«ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã‹ï¼Ÿ
ãƒ»å‹•æ©Ÿã¨ã®ä¸€è‡´ï¼šå­¦ç¿’è€…ã«ã‚„ã‚ŠãŒã„ã‚’å®Ÿæ„Ÿã—ã¦ã‚‚ã‚‰ã†ãƒ™ã‚¹ãƒˆãªæ–¹æ³•ãƒ»æ™‚æœŸã¨ã¯ï¼Ÿ
â—‹è‡ªä¿¡Confidenceï¼å­¦ç¿’éç¨‹ã§æˆåŠŸä½“é¨“ã‚’å‘³ã‚ã£ã¦ã‚‚ã‚‰ã„ã€ãã®æˆåŠŸãŒè‡ªåˆ†ã®èƒ½åŠ›ã‚„åŠªåŠ›ã«ã‚ˆã‚‹ã‚‚ã®ã ã¨æ€ã‚ã›ã‚‹ã“ã¨ã§ã€Œã‚„ã‚Œã°ã§ãã‚‹ã€ã¨ã„ã†è‡ªä¿¡ã«ã¤ãªãå´é¢ã§ã™ã€‚è‡ªä¿¡ã®å´é¢ã‚‚ä»¥ä¸‹ã®3ã¤ã«åˆ†é¡ã§ãã¾ã™ã€‚
ãƒ»å­¦ç¿’æ¬²æ±‚ï¼šå­¦ç¿’è€…ãŒã€Œã‚„ã‚Œã°ã§ããã†ã€ã¨ã„ã†æœŸå¾…æ„Ÿã‚’æŠ±ãã«ã¯ã©ã†ã™ã¹ãã‹ï¼Ÿ 
ãƒ»æˆåŠŸã®æ©Ÿä¼šï¼šæˆåŠŸä½“é¨“ã‚’é€šã—ã¦å­¦ç¿’è€…ãŒè‡ªåˆ†ã®èƒ½åŠ›ã«å¯¾ã™ã‚‹ä¿¡é ¼ã‚’é«˜ã‚ã‚‹ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨ã¯ä½•ã‹ï¼Ÿ 
ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®å€‹äººåŒ–ï¼šå­¦ç¿’è€…ãŒã€æˆåŠŸä½“é¨“ãŒè‡ªåˆ†ã®åŠªåŠ›ã¨èƒ½åŠ›ã«ã‚ˆã‚‹ã‚‚ã®ã ã¨èªè­˜ã™ã‚‹ãŸã‚ã«ã¯ä½•ã‚’ã™ã¹ãã‹ï¼Ÿ
â—‹æº€è¶³Satisfactionï¼å­¦ç¿’éç¨‹ã§ã®åŠªåŠ›ã‚„èº«ã«ä»˜ã‘ãŸæŠ€èƒ½ã®æœ‰åŠ¹æ€§ã‚’å®Ÿæ„Ÿã•ã›ã‚‹ã“ã¨ã§ã€ã€Œã‚„ã£ã¦ã‚ˆã‹ã£ãŸã€ã¨ã„ã†æº€è¶³æ„Ÿã‚’ä¸ãˆã€æ–°ãŸãªå­¦ç¿’æ„æ¬²ã‚’å¼•ãå‡ºã™å´é¢ã§ã™ã€‚ã“ã“ã§ã®æº€è¶³æ„Ÿã¯ã€ä»¥ä¸‹ã®3ç¨®é¡ã«åˆ†ã‹ã‚Œã¾ã™ã€‚
ãƒ»å†…ç™ºçš„ãªå¼·åŒ–ï¼šå­¦ç¿’è€…ã®å¿ƒã«ç”Ÿã¾ã‚ŒãŸã€å­¦ç¿’ã«å¯¾ã™ã‚‹èˆˆå‘³ãƒ»é–¢å¿ƒã‚’å‘ä¸Šã•ã›ã‚‹ã«ã¯ã©ã†ã™ã¹ãã‹ï¼Ÿ
ãƒ»å¤–ç™ºçš„å ±é…¬ï¼šå­¦ç¿’è€…ã®æˆæœã«å¯¾ã—ã¦ã€ã©ã®ã‚ˆã†ãªç§°è³›ã‚„å ±é…¬ã‚’æä¾›ã™ã¹ãã‹ï¼Ÿ
ãƒ»å…¬å¹³ã•ï¼šå­¦ç¿’è€…ãŒå…¬å¹³ã«è©•ä¾¡ã•ã‚Œã¦ã„ã‚‹ã¨å®Ÿæ„Ÿã™ã‚‹ãŸã‚ã«ã¯ä½•ã‚’ã™ã¹ãã‹ï¼Ÿ
â—‹æ„å¿—Volitionï¼ç›®æ¨™ã‚’é”æˆã™ã‚‹ãŸã‚ã«åŠªåŠ›ã— ç¶šã‘ã‚‹ã“ã¨ã«é–¢é€£ã™ã‚‹è¡Œå‹•ã¨æ…‹åº¦å…¨èˆ¬ã‚’ç¤ºã™ æ¦‚å¿µã€ã¨å®šç¾©ã•ã‚Œã¦ãŠã‚Šï¼ŒMotivation ã¯ã€Œäººã€… ãŒä½•ã‚’æœ›ã¿ã€ä½•ã‚’é¸ã‚“ã§è¡Œã„ã€ãã—ã¦ä½•ã‚’è¡Œã†ã“ã¨ã«å…¨åŠ›ã‚’å‚¾ã‘ã‚‹ã‹ã‚’ä¸€èˆ¬çš„ã«æ„å‘³ã™ã‚‹
ãƒ»å®Ÿè¡Œè¨ˆç”»ã®å…·ä½“åŒ–ï¼ˆImplementation Intentionï¼‰ ã‚„ã‚‹æ°—ã‚’æ˜ç¤ºã•ã›ã‚‹
ãƒ»é©åˆ‡ãªåˆ¶å¾¡ï¼ˆAppropriate Self-controlï¼‰ è¨±å®¹ç¯„å›²ã§é€²ã‚ã•ã›ã‚‹
ãƒ»è‡ªå·±ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆSelf-monitoringï¼‰ è‡ªåˆ†ã®çŠ¶æ³ã‚’ç†è§£ã•ã›ã‚‹
ï¼’ï¼å­¦ç¿’æ—¥è¨˜å—ã‘å–ã‚Šå¾Œã®å¯¾è©±
â€¢     å­¦ç¿’è€…ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸå­¦ç¿’æ—¥è¨˜ã®å†…å®¹ã‚’ã‚‚ã¨ã«ã€ARCS-Vãƒ¢ãƒ‡ãƒ«ã®è¦–ç‚¹ã‚’è‡ªç„¶ã«ç¹”ã‚Šäº¤ãœãªãŒã‚‰ã€è³ªå•ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
â€¢     è³ªå•ã¯ä¸€åº¦ã«ä½•å•ã‚‚é€ä»˜ã›ãšã€è‡ªç„¶ãªä¼šè©±ã®ã‚ˆã†ã«1å•ãšã¤æŠ•ã’ã‹ã‘ã¦ãã ã•ã„ã€‚
â€¢     ARCS-Vã®å„è¦ç´ ã‚’1ã¤ãšã¤æ˜ç¤ºçš„ã«åˆ†ã‘ã¦è³ªå•ã™ã‚‹ã®ã§ã¯ãªãã€å­¦ç¿’è€…ã®è©±ã«å¿œã˜ã¦è‡ªç„¶ãªæµã‚Œã§æ·±æ˜ã‚Šã—ãªãŒã‚‰ã€å‹•æ©Ÿã¥ã‘ã‚„èª²é¡Œæ„Ÿã‚’å¼•ãå‡ºã—ã¦ãã ã•ã„ã€‚
â€¢     å¯¾è©±ã¯è¦ªã—ã¿ã‚„ã™ãã€ã‹ã¤ç›¸æ‰‹ãŒç–²ã‚Œãªã„ã‚ˆã†ã€è³ªå•ã®æ•°ã¯4å•å‰å¾Œã«æŠ‘ãˆã€é©åº¦ãªå¿œç­”ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
â€¢     è¨­å•ã¯ä¸€åº¦ã«å…¨ã¦æç¤ºã—ãªã„ã§ã€ä¼šè©±ã®æµã‚Œã§å•ã„ã‹ã‘ã‚‹ã‚ˆã†ãªå¯¾è©±ãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã€ã‚³ãƒ¼ãƒãƒ³ã‚°ã®ãƒ’ã‚¢ãƒªãƒ³ã‚°ã®ã‚ˆã†ãªä¼šè©±ã§ã™ã€‚
â€¢     å­¦ç¿’è€…ãŒå‰å‘ãã«å­¦ã³ã‚’ç¶šã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã€åŠ±ã¾ã—ã‚„å…±æ„Ÿã‚‚äº¤ãˆãŸå¯¾è©±ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
ï¼“ï¼å¯¾è©±çµ‚äº†å¾Œã®æµã‚Œ
â€¢     å¯¾è©±ãŒè½ã¡ç€ã„ãŸã‚‰ã€æœ€å¾Œã«ç·æ‹¬ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¦å¯¾è©±ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
â€¢     å¯¾è©±ã®ã¾ã¨ã‚ã¨ã—ã¦ã€è¨˜éŒ²ã‚ˆã†ã«å½“æ—¥ã®å¯¾è©±ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã‚¢ãƒ³ãƒ‰ãƒšãƒ¼ã‚¹ãƒˆã§ãã‚‹å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
â€¢     ç¿Œæ—¥ä»¥é™ã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸéš›ã«ã¯ã€ãã‚Œã¾ã§ã®å¯¾è©±ã®å†…å®¹ã‚‚è¸ã¾ãˆã¦å­¦ç¿’ç›®æ¨™ã‚’é”æˆã§ãã‚‹ã‚ˆã†Kellerã®ARCS-Vãƒ¢ãƒ‡ãƒ«ï¼ˆæ³¨æ„Attentionãƒ»é–¢é€£æ€§Relevanceãƒ»è‡ªä¿¡Confidenceãƒ»æº€è¶³Satisfactionãƒ»æ„å¿—Volitionï¼‰ã‚’è¸ã¾ãˆãŸå¯¾è©±ã‚’è¡Œã„ã€å­¦ç¿’è€…ã®å­¦ç¿’æ„æ¬²ã®ç¶­æŒã¨å­¦ç¿’ç›®æ¨™é”æˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚
ï¼”ï¼ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®å½¹å‰²ã¨æŒ¯ã‚‹èˆã„
â€¢     å­¦ç¿’è€…ãŒè‡ªåˆ†ã®è¨€è‘‰ã§å­¦ã³ã‚’æŒ¯ã‚Šè¿”ã‚Šã€æ°—ã¥ãã‚’æ·±ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«å°ãã“ã¨ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚
â€¢     å­¦ã‚“ã§ã„ã‚‹å†…å®¹ãã®ã‚‚ã®ã«ã¤ã„ã¦ã€è£œè¶³çš„æƒ…å ±ã‚’æä¾›ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
â€¢     å¿…è¦ã«å¿œã˜ã¦ã€è³ªå•ã‚’æŠ•ã’ã‹ã‘ãŸã‚Šã€è¦ç´„ã—ã¦è¿”ã—ãŸã‚Šã—ãªãŒã‚‰ã€å­¦ç¿’è€…ãŒè‡ªåˆ†ã®è€ƒãˆã‚„æ„Ÿæƒ…ã«æ°—ã¥ã‘ã‚‹ã‚ˆã†ã‚µãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚
â€¢     å¯¾è©±ãŒå˜èª¿ã«ãªã‚‰ãªã„ã‚ˆã†ã€é©åº¦ã«è³ªå•ã®è¡¨ç¾ã‚„åˆ‡ã‚Šå£ã‚’å¤‰ãˆã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚
 
ã“ã®ã‚ˆã†ãªå½¹å‰²ãƒ»æ¡ä»¶ã‚’è¸ã¾ãˆã€
ã€Œæœ€åˆã«ç›®æ¨™ã‚’å°‹ã­ã€ä»¥é™ã¯å­¦ç¿’æ—¥è¨˜ã«å¯¾ã—ã¦4ã¤ã»ã©ã®è³ªå•ã‹ã‚‰è‡ªç„¶ãªå¯¾è©±ã‚’ç¹°ã‚Šåºƒã’ã¦ãã ã•ã„ã€‚ARCS-Vã‚’æ„è­˜ã—ã¤ã¤å­¦ç¿’è€…ã®å†…é¢ã‚’æ·±ã‚ã‚‹æ”¯æ´ã‚’è¡Œã†ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã€ã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„ã€‚
æœ€å¾Œã®å¿œç­”ã§ã¯ã€å¿…ãšå¯¾è©±ã®çµ‚äº†ã‚’å‘Šã’ã€**ãã®æ—¥ã®å­¦ç¿’ã®ç·æ‹¬ã¨ç°¡å˜ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**ã‚’åŠ ãˆã¦ãã ã•ã„ã€‚
    # Do not remove the following line.
    # ã“ã®è¡Œã¯å‰Šé™¤ã—ãªã„ã§ãã ã•ã„ã€‚
    \nãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:\n{st.session_state.document_content}"""
            
            history.append({'role': 'user', 'parts': [document_context]})
            
            # === æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚‚è¿½åŠ  ===
            for msg in st.session_state.messages:
                if isinstance(msg, dict) and "role" in msg and "content" in msg:
                    role = "user" if msg["role"] == "user" else "model"
                    history.append({'role': role, 'parts': [msg["content"]]})
            
            # historyãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
            if not history:
                st.warning("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒç©ºã§ã™ã€‚APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚")
                st.stop()
                
            # Gemini APIã‚’ä½¿ç”¨ã—ã¦å¿œç­”ã‚’ç”Ÿæˆï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰
            response_stream = model.generate_content(
                history,
                stream=True
            )

            # å¿œç­”ã‚’ãƒãƒ£ãƒƒãƒˆã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤ºã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«ä¿å­˜
            full_response = ""
            with st.chat_message("assistant"):
                message_placeholder = st.empty()
                for chunk in response_stream:
                    if chunk.parts:
                        text_part = chunk.parts[0].text
                        full_response += text_part
                        message_placeholder.markdown(full_response + "â–Œ")
                message_placeholder.markdown(full_response)
            
            st.session_state.messages.append({"role": "assistant", "content": full_response})

        except Exception as e:
            st.error("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
            print(f"ã‚¨ãƒ©ãƒ¼ã®è©³ç´°: {e}", file=sys.stderr)
            st.session_state.messages.append({"role": "assistant", "content": "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€å¿œç­”ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"})
    
    # === Wordãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ãƒœã‚¿ãƒ³ã®è¿½åŠ  (å¯¾è©±ãŒçµ‚äº†ã—ãŸå ´åˆã®ã¿è¡¨ç¤º) ===
    if len(st.session_state.messages) >= 10:
        doc = docx.Document()
        doc.add_heading('ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š', 0)
        for message in st.session_state.messages:
            if message["role"] == "user":
                doc.add_paragraph(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼: {message['content']}")
            else:
                doc.add_paragraph(f"ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ: {message['content']}")

        # ãƒ¡ãƒ¢ãƒªä¸Šã§docxãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        doc_io = io.BytesIO()
        doc.save(doc_io)
        doc_io.seek(0)

        st.download_button(
            label="æŒ¯ã‚Šè¿”ã‚Šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
            data=doc_io,
            file_name="æŒ¯ã‚Šè¿”ã‚Š.docx",
            mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document")
        
